<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸‰å¥åŠÂ·æ™ºèƒ½æ‰“å‡»ä¹æ‰‹ï¼ˆæœ‰å£°ç‰ˆï¼‰</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: "Microsoft YaHei", sans-serif; 
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: white; 
            min-height: 100vh;
            padding: 20px;
            touch-action: manipulation;
        }
        .container { max-width: 500px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 30px; padding: 20px; }
        h1 { font-size: 2rem; margin-bottom: 10px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .subtitle { opacity: 0.9; font-size: 1rem; margin-bottom: 10px; }
        .tip { 
            background: rgba(255,255,255,0.1); 
            padding: 10px; border-radius: 10px; 
            font-size: 0.9rem; margin-top: 10px;
        }
        
        /* è§’è‰²é€‰æ‹© */
        .role-selection { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 15px; 
            margin-bottom: 30px; 
        }
        .role-btn {
            background: rgba(255,255,255,0.15); 
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 15px; 
            padding: 25px 10px; 
            font-size: 1.8rem;
            color: white; 
            cursor: pointer; 
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }
        .role-btn:hover, .role-btn:active { 
            background: rgba(255,255,255,0.25); 
            transform: translateY(-2px); 
        }
        .role-btn.active { 
            background: rgba(255,215,0,0.3); 
            border-color: gold; 
            box-shadow: 0 0 15px gold;
        }
        
        /* ä¹å™¨é€‰æ‹© */
        .instrument-selection { display: none; margin-bottom: 30px; }
        .instrument-title { 
            text-align: center; 
            margin-bottom: 20px; 
            font-size: 1.3rem;
        }
        .instruments { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 12px; 
        }
        .instrument-btn {
            background: rgba(0,0,0,0.2); 
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 12px; 
            padding: 20px 10px; 
            font-size: 1.1rem;
            color: white; 
            cursor: pointer;
            transition: all 0.2s;
        }
        .instrument-btn:hover, .instrument-btn:active { 
            background: rgba(255,255,255,0.1); 
            transform: scale(0.98);
        }
        
        /* æ¼”å¥ç•Œé¢ */
        .performance-screen { 
            display: none; 
            position: fixed; 
            top: 0; left: 0; 
            width: 100%; height: 100%; 
            background: linear-gradient(45deg, #8B0000, #00008B);
            z-index: 100;
        }
        .home-btn {
            position: absolute; 
            top: 20px; right: 20px; 
            background: rgba(255,255,255,0.2); 
            width: 50px; height: 50px; 
            border-radius: 50%;
            display: flex; 
            align-items: center; 
            justify-content: center;
            font-size: 1.5rem; 
            cursor: pointer; 
            z-index: 101;
            border: none;
            color: white;
        }
        .drum-loop-btn {
            position: absolute; 
            bottom: 30px; right: 30px;
            background: rgba(255,215,0,0.7); 
            color: #333;
            padding: 12px 18px; 
            border-radius: 25px;
            font-weight: bold; 
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            border: none;
            font-size: 1rem;
        }
        .current-role { 
            position: absolute; 
            top: 30px; left: 20px; 
            font-size: 1.2rem; 
            background: rgba(0,0,0,0.3);
            padding: 8px 15px;
            border-radius: 20px;
        }
        .touch-hint {
            position: absolute;
            bottom: 100px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 1.1rem;
            opacity: 0.8;
        }
        
        /* å“åº”å¼ */
        @media (max-width: 600px) {
            h1 { font-size: 1.6rem; }
            .role-btn { 
                padding: 20px 10px; 
                font-size: 1.5rem; 
            }
            .current-role { 
                top: 20px; 
                left: 20px; 
                font-size: 1rem; 
            }
        }
        
        /* åŠ è½½æç¤º */
        .loading { 
            text-align: center; 
            padding: 20px; 
            display: none;
        }
        .volume-test {
            background: rgba(0,200,0,0.3);
            padding: 10px;
            border-radius: 10px;
            margin: 10px 0;
            text-align: center;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ„ ä¸‰å¥åŠæ™ºèƒ½æ‰“å‡»ä¹æ‰‹ ğŸ¥</h1>
            <p class="subtitle">é€‰è§’è‰² â†’ æŒ‘ä¹å™¨ â†’ å…¨å±ç‚¹å‡»æ¼”å¥ï¼</p>
            <div class="tip">
                <strong>ä½¿ç”¨æç¤ºï¼š</strong>ç‚¹å‡»ä¸‹æ–¹"æµ‹è¯•å£°éŸ³"æŒ‰é’®ï¼Œç¡®è®¤èƒ½å¬åˆ°"å’š"å£°åå¼€å§‹ä½¿ç”¨ï¼
            </div>
            <div class="volume-test" id="volumeTest">
                ğŸ”Š ç‚¹å‡»è¿™é‡Œæµ‹è¯•å£°éŸ³ ğŸ”Š
            </div>
        </header>
        
        <!-- ç¬¬ä¸€å±ï¼šè§’è‰²é€‰æ‹© -->
        <section id="roleScreen" class="role-selection">
            <button class="role-btn" data-role="ç”²">ç”²</button>
            <button class="role-btn" data-role="ä¹™">ä¹™</button>
            <button class="role-btn" data-role="ä¸™">ä¸™</button>
            <button class="role-btn" data-role="ä¸">ä¸</button>
        </section>
        
        <!-- ç¬¬äºŒå±ï¼šä¹å™¨é€‰æ‹© -->
        <section id="instrumentScreen" class="instrument-selection">
            <h2 class="instrument-title" id="instrumentTitle">é€‰æ‹©ä½ çš„ä¹å™¨</h2>
            <div class="instruments" id="instrumentList">
                <!-- ä¹å™¨æŒ‰é’®ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </section>
        
        <!-- ç¬¬ä¸‰å±ï¼šæ¼”å¥ç•Œé¢ -->
        <section id="performanceScreen" class="performance-screen">
            <button class="home-btn" id="homeBtn">ğŸ </button>
            <div class="current-role" id="currentRoleDisplay"></div>
            <div class="touch-hint">ğŸ‘† ç‚¹å‡»å±å¹•ä»»æ„ä½ç½®æ¼”å¥ ğŸ‘†</div>
            <button class="drum-loop-btn" id="drumLoopBtn">ğŸµ å¼€å¯é¼“ç‚¹å¾ªç¯</button>
        </section>
        
        <!-- åŠ è½½æç¤º -->
        <div class="loading" id="loading">
            æ­£åœ¨åˆå§‹åŒ–éŸ³é¢‘å¼•æ“...
        </div>
    </div>

    <script>
        // çŠ¶æ€å˜é‡
        let currentRole = '';
        let currentInstrument = '';
        let audioContext;
        let isDrumLoopPlaying = false;
        let drumLoopInterval;
        
        // åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡ï¼ˆå…¼å®¹æ‰€æœ‰æµè§ˆå™¨ï¼‰
        function initAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                console.log('éŸ³é¢‘å¼•æ“å¯åŠ¨æˆåŠŸï¼');
                document.getElementById('loading').style.display = 'none';
                
                // è‡ªåŠ¨æ’­æ”¾è§£é”ï¼ˆç”¨æˆ·äº¤äº’åï¼‰
                document.body.addEventListener('click', function unlockAudio() {
                    if (audioContext.state === 'suspended') {
                        audioContext.resume();
                    }
                    document.body.removeEventListener('click', unlockAudio);
                });
                
            } catch (e) {
                console.error('éŸ³é¢‘åˆå§‹åŒ–å¤±è´¥:', e);
                alert('æç¤ºï¼šè¯·ç¡®ä¿æ‰‹æœºæœªé™éŸ³ï¼Œå¹¶è°ƒå¤§éŸ³é‡ï¼');
            }
        }
        
        // ç”ŸæˆåˆæˆéŸ³æ•ˆ
        function playSynthesizedSound(type) {
            if (!audioContext) return;
            
            try {
                const now = audioContext.currentTime;
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                // æ ¹æ®ä¸åŒä¹å™¨è®¾ç½®ä¸åŒéŸ³è‰²
                let frequency = 440;
                let duration = 0.3;
                
                switch(type) {
                    case 'æœ¨é±¼': frequency = 800; duration = 0.1; break;
                    case 'å“æ¿': frequency = 1200; duration = 0.05; break;
                    case 'é“ƒé“›': frequency = 1567; duration = 0.8; break;
                    case 'å°é¼“': frequency = 150; duration = 0.2; break;
                    case 'æ²™é”¤': 
                        // æ²™é”¤æ•ˆæœï¼šå™ªå£°
                        const bufferSize = audioContext.sampleRate * duration;
                        const buffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
                        const output = buffer.getChannelData(0);
                        for (let i = 0; i < bufferSize; i++) {
                            output[i] = Math.random() * 2 - 1;
                        }
                        const noise = audioContext.createBufferSource();
                        noise.buffer = buffer;
                        noise.connect(gainNode);
                        noise.start();
                        break;
                    case 'æ‹æ¿': frequency = 500; duration = 0.15; break;
                    case 'é•²': frequency = 2000; duration = 0.5; break;
                    case 'é“ƒé¼“': frequency = 800; duration = 0.3; break;
                    case 'æ¬¢å‘¼': frequency = 600; duration = 0.4; break;
                    case 'å¤§é”£': frequency = 300; duration = 1.0; break;
                    case 'ä½éŸ³é¼“': frequency = 100; duration = 0.4; break;
                    case 'çˆ†ç‚¸': frequency = 80; duration = 0.6; break;
                }
                
                if (type !== 'æ²™é”¤') {
                    oscillator.type = type === 'å¤§é”£' ? 'sine' : 
                                     type === 'é“ƒé“›' ? 'sine' : 'square';
                    oscillator.frequency.setValueAtTime(frequency, now);
                    oscillator.connect(gainNode);
                    oscillator.start(now);
                    oscillator.stop(now + duration);
                }
                
                gainNode.connect(audioContext.destination);
                
                // éŸ³é‡åŒ…ç»œ
                gainNode.gain.setValueAtTime(0.5, now);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + duration);
                
            } catch (e) {
                console.log('æ’­æ”¾å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ');
                // å¤‡ç”¨ï¼šæ’­æ”¾ç®€å•çš„Beepå£°
                playFallbackSound();
            }
        }
        
        // å¤‡ç”¨éŸ³æ•ˆ
        function playFallbackSound() {
            try {
                const audio = new Audio();
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = ctx.createOscillator();
                oscillator.connect(ctx.destination);
                oscillator.start();
                setTimeout(() => oscillator.stop(), 100);
            } catch (e) {
                // ç»ˆæå¤‡ç”¨ï¼šæŒ¯åŠ¨ï¼ˆå¦‚æœæ‰‹æœºæ”¯æŒï¼‰
                if (navigator.vibrate) {
                    navigator.vibrate(50);
                }
            }
        }
        
        // æ’­æ”¾éŸ³æ•ˆ
        function playSound(instrumentName) {
            if (!audioContext) {
                initAudio();
            }
            playSynthesizedSound(instrumentName);
        }
        
        // å¼€å§‹é¼“ç‚¹å¾ªç¯
        function startDrumLoop() {
            if (isDrumLoopPlaying) return;
            
            isDrumLoopPlaying = true;
            const btn = document.getElementById('drumLoopBtn');
            btn.textContent = 'â¹ï¸ å…³é—­é¼“ç‚¹å¾ªç¯';
            btn.style.background = 'rgba(255,50,50,0.7)';
            
            // ç®€å•çš„é¼“ç‚¹å¾ªç¯ï¼šå’š æ¬¡æ¬¡ å’š æ¬¡æ¬¡
            let beat = 0;
            drumLoopInterval = setInterval(() => {
                if (!audioContext) return;
                
                const now = audioContext.currentTime;
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // å¼ºæ‹ï¼ˆå’šï¼‰
                if (beat % 4 === 0) {
                    oscillator.frequency.setValueAtTime(150, now);
                    gainNode.gain.setValueAtTime(0.3, now);
                } 
                // å¼±æ‹ï¼ˆæ¬¡æ¬¡ï¼‰
                else if (beat % 2 === 0) {
                    oscillator.frequency.setValueAtTime(800, now);
                    gainNode.gain.setValueAtTime(0.1, now);
                } else {
                    oscillator.stop();
                    return;
                }
                
                oscillator.start(now);
                oscillator.stop(now + 0.1);
                
                beat = (beat + 1) % 4;
            }, 250); // æ¯åˆ†é’Ÿ240æ‹
        }
        
        // åœæ­¢é¼“ç‚¹å¾ªç¯
        function stopDrumLoop() {
            isDrumLoopPlaying = false;
            clearInterval(drumLoopInterval);
            const btn = document.getElementById('drumLoopBtn');
            btn.textContent = 'ğŸµ å¼€å¯é¼“ç‚¹å¾ªç¯';
            btn.style.background = 'rgba(255,215,0,0.7)';
        }
        
        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', () => {
            // æµ‹è¯•æŒ‰é’®
            document.getElementById('volumeTest').addEventListener('click', function() {
                initAudio();
                setTimeout(() => {
                    playSound('å¤§é”£');
                    this.style.background = 'rgba(0,150,0,0.5)';
                    this.innerHTML = 'âœ… å£°éŸ³æµ‹è¯•é€šè¿‡ï¼å¯ä»¥å¼€å§‹ä½¿ç”¨äº†';
                }, 100);
            });
            
            // è§’è‰²é€‰æ‹©äº‹ä»¶
            document.querySelectorAll('.role-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    currentRole = this.dataset.role;
                    document.querySelectorAll('.role-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // æ˜¾ç¤ºä¹å™¨é€‰æ‹©
                    document.getElementById('roleScreen').style.display = 'none';
                    const instrumentScreen = document.getElementById('instrumentScreen');
                    instrumentScreen.style.display = 'block';
                    document.getElementById('instrumentTitle').textContent = `è§’è‰²ã€${currentRole}ã€‘é€‰æ‹©ä¹å™¨`;
                    
                    // ä¹å™¨é…ç½®
                    const instruments = {
                        'ç”²': ['æœ¨é±¼', 'å“æ¿', 'é“ƒé“›'],
                        'ä¹™': ['å°é¼“', 'æ²™é”¤', 'æ‹æ¿'],
                        'ä¸™': ['é•²', 'é“ƒé¼“', 'æ¬¢å‘¼'],
                        'ä¸': ['å¤§é”£', 'ä½éŸ³é¼“', 'çˆ†ç‚¸']
                    };
                    
                    // ç”Ÿæˆä¹å™¨æŒ‰é’®
                    const instrumentList = document.getElementById('instrumentList');
                    instrumentList.innerHTML = '';
                    instruments[currentRole].forEach(instrument => {
                        const btn = document.createElement('button');
                        btn.className = 'instrument-btn';
                        btn.textContent = instrument;
                        btn.addEventListener('click', function() {
                            currentInstrument = instrument;
                            startPerformance();
                        });
                        instrumentList.appendChild(btn);
                    });
                });
            });
            
            // ä¸»é¡µæŒ‰é’®
            document.getElementById('homeBtn').addEventListener('click', function() {
                stopDrumLoop();
                document.getElementById('performanceScreen').style.display = 'none';
                document.getElementById('roleScreen').style.display = 'grid';
                document.getElementById('instrumentScreen').style.display = 'none';
            });
            
            // é¼“ç‚¹å¾ªç¯æŒ‰é’®
            document.getElementById('drumLoopBtn').addEventListener('click', function() {
                if (!isDrumLoopPlaying) {
                    startDrumLoop();
                } else {
                    stopDrumLoop();
                }
            });
            
            // æ¼”å¥ç•Œé¢ç‚¹å‡»äº‹ä»¶
            document.getElementById('performanceScreen').addEventListener('click', function(e) {
                // æ’é™¤æŒ‰é’®åŒºåŸŸ
                if (e.target.id === 'drumLoopBtn' || e.target.id === 'homeBtn') return;
                
                if (currentInstrument) {
                    playSound(currentInstrument);
                }
            });
        });
        
        // å¼€å§‹æ¼”å¥
        function startPerformance() {
            document.getElementById('instrumentScreen').style.display = 'none';
            const perfScreen = document.getElementById('performanceScreen');
            perfScreen.style.display = 'block';
            document.getElementById('currentRoleDisplay').textContent = 
                `${currentRole}ï¼š${currentInstrument}`;
            
            // é¢„åŠ è½½éŸ³é¢‘
            if (!audioContext) {
                initAudio();
            }
        }
        
        // é˜²æ­¢å±å¹•ä¼‘çœ 
        if ('wakeLock' in navigator) {
            try {
                navigator.wakeLock.request('screen');
            } catch (err) {
                console.log('é˜²ä¼‘çœ åŠŸèƒ½ä¸å¯ç”¨');
            }
        }
        
        // è§¦æ‘¸åé¦ˆ
        document.addEventListener('touchstart', function() {
            // ç¡®ä¿éŸ³é¢‘ä¸Šä¸‹æ–‡å·²æ¿€æ´»
            if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }, { passive: true });
    </script>
</body>
</html>

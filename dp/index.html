<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸‰å¥åŠÂ·ä¸“ä¸šæ‰“å‡»ä¹æ‰‹ï¼ˆæ··å“ç‰ˆï¼‰</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: "Microsoft YaHei", sans-serif; 
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            color: white; 
            min-height: 100vh;
            padding: 20px;
            touch-action: manipulation;
        }
        .container { max-width: 500px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 30px; padding: 20px; }
        h1 { 
            font-size: 2rem; 
            margin-bottom: 10px; 
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
            background: linear-gradient(90deg, #ff8a00, #e52e71);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .subtitle { 
            opacity: 0.9; 
            font-size: 1rem; 
            margin-bottom: 10px;
            color: #a0d2ff;
        }
        
        /* æ•ˆæœå™¨æ§åˆ¶é¢æ¿ */
        .effects-panel {
            background: rgba(255,255,255,0.08);
            border-radius: 15px;
            padding: 15px;
            margin: 15px 0;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .effect-control {
            margin: 10px 0;
        }
        .effect-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        .slider {
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            outline: none;
        }
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4cc9f0;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(76, 201, 240, 0.5);
        }
        
        /* è§’è‰²é€‰æ‹© */
        .role-selection { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 15px; 
            margin-bottom: 25px; 
        }
        .role-btn {
            background: rgba(255,255,255,0.1); 
            border: 2px solid rgba(76, 201, 240, 0.3);
            border-radius: 15px; 
            padding: 25px 10px; 
            font-size: 1.8rem;
            color: white; 
            cursor: pointer; 
            transition: all 0.3s;
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }
        .role-btn::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s;
        }
        .role-btn:active::after {
            opacity: 1;
        }
        .role-btn.active { 
            background: linear-gradient(135deg, rgba(76, 201, 240, 0.3), rgba(156, 39, 176, 0.3)); 
            border-color: #4cc9f0; 
            box-shadow: 0 0 20px rgba(76, 201, 240, 0.5);
            transform: translateY(-3px);
        }
        
        /* ä¹å™¨é€‰æ‹© */
        .instrument-selection { display: none; margin-bottom: 30px; }
        .instrument-title { 
            text-align: center; 
            margin-bottom: 20px; 
            font-size: 1.4rem;
            color: #4cc9f0;
        }
        .instruments { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 12px; 
        }
        .instrument-btn {
            background: rgba(0,0,0,0.3); 
            border: 2px solid rgba(255,255,255,0.15);
            border-radius: 12px; 
            padding: 20px 10px; 
            font-size: 1.1rem;
            color: white; 
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        .instrument-btn:hover, .instrument-btn:active { 
            background: rgba(76, 201, 240, 0.2); 
            border-color: #4cc9f0;
            transform: scale(0.98);
        }
        
        /* æ¼”å¥ç•Œé¢ */
        .performance-screen { 
            display: none; 
            position: fixed; 
            top: 0; left: 0; 
            width: 100%; height: 100%; 
            background: radial-gradient(circle at center, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            z-index: 100;
        }
        .home-btn {
            position: absolute; 
            top: 20px; right: 20px; 
            background: rgba(255,255,255,0.15); 
            width: 50px; height: 50px; 
            border-radius: 50%;
            display: flex; 
            align-items: center; 
            justify-content: center;
            font-size: 1.5rem; 
            cursor: pointer; 
            z-index: 101;
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            backdrop-filter: blur(10px);
        }
        .drum-loop-btn {
            position: absolute; 
            bottom: 30px; right: 30px;
            background: linear-gradient(135deg, #ff8a00, #e52e71); 
            color: white;
            padding: 12px 20px; 
            border-radius: 25px;
            font-weight: bold; 
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(229, 46, 113, 0.4);
            border: none;
            font-size: 1rem;
            z-index: 101;
        }
        .current-role { 
            position: absolute; 
            top: 30px; left: 20px; 
            font-size: 1.2rem; 
            background: rgba(0,0,0,0.4);
            padding: 10px 20px;
            border-radius: 25px;
            border: 1px solid rgba(76, 201, 240, 0.3);
            backdrop-filter: blur(10px);
        }
        .touch-hint {
            position: absolute;
            bottom: 100px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 1.1rem;
            opacity: 0.8;
            text-shadow: 0 2px 5px rgba(0,0,0,0.5);
            color: #a0d2ff;
        }
        
        /* éŸ³é¢‘å¯è§†åŒ– */
        .visualizer {
            position: absolute;
            bottom: 180px;
            left: 20px;
            right: 20px;
            height: 60px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .wave {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to top, 
                transparent 0%, 
                rgba(76, 201, 240, 0.1) 30%,
                rgba(76, 201, 240, 0.3) 70%,
                rgba(156, 39, 176, 0.5) 100%);
            transform-origin: bottom;
        }
        
        @media (max-width: 600px) {
            h1 { font-size: 1.6rem; }
            .role-btn { padding: 20px 10px; font-size: 1.5rem; }
            .current-role { top: 20px; font-size: 1rem; }
        }
        
        .test-btn {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            background: linear-gradient(135deg, #4cc9f0, #4361ee);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            cursor: pointer;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸšï¸ ä¸‰å¥åŠÂ·ä¸“ä¸šæ‰“å‡»ä¹æ‰‹</h1>
            <p class="subtitle">å¸¦æ··å“+å›å£°çš„ä¸“ä¸šéŸ³æ•ˆ | å…¨å±è§¦æ§æ¼”å¥</p>
            
            <!-- æ•ˆæœå™¨æ§åˆ¶é¢æ¿ -->
            <div class="effects-panel">
                <div class="effect-control">
                    <div class="effect-label">
                        <span>æ··å“å¼ºåº¦</span>
                        <span id="reverbValue">0.6</span>
                    </div>
                    <input type="range" min="0" max="1" step="0.1" value="0.6" class="slider" id="reverbSlider">
                </div>
                <div class="effect-control">
                    <div class="effect-label">
                        <span>å›å£°å»¶è¿Ÿ</span>
                        <span id="delayValue">0.3s</span>
                    </div>
                    <input type="range" min="0" max="0.8" step="0.1" value="0.3" class="slider" id="delaySlider">
                </div>
                <div class="effect-control">
                    <div class="effect-label">
                        <span>å›å£°æ¬¡æ•°</span>
                        <span id="feedbackValue">3</span>
                    </div>
                    <input type="range" min="1" max="5" step="1" value="3" class="slider" id="feedbackSlider">
                </div>
            </div>
            
            <button class="test-btn" id="testSoundBtn">
                ğŸ”Š ç‚¹å‡»æµ‹è¯•ä¸“ä¸šéŸ³æ•ˆï¼ˆå¸¦æ··å“ï¼‰
            </button>
        </header>
        
        <!-- è§’è‰²é€‰æ‹© -->
        <section id="roleScreen" class="role-selection">
            <button class="role-btn" data-role="ç”²">ç”²</button>
            <button class="role-btn" data-role="ä¹™">ä¹™</button>
            <button class="role-btn" data-role="ä¸™">ä¸™</button>
            <button class="role-btn" data-role="ä¸">ä¸</button>
        </section>
        
        <!-- ä¹å™¨é€‰æ‹© -->
        <section id="instrumentScreen" class="instrument-selection">
            <h2 class="instrument-title" id="instrumentTitle">é€‰æ‹©ä½ çš„ä¹å™¨</h2>
            <div class="instruments" id="instrumentList"></div>
        </section>
        
        <!-- æ¼”å¥ç•Œé¢ -->
        <section id="performanceScreen" class="performance-screen">
            <button class="home-btn" id="homeBtn">ğŸ </button>
            <div class="current-role" id="currentRoleDisplay"></div>
            <div class="touch-hint">ğŸ‘‡ è½»è§¦å±å¹•æ¼”å¥ | é•¿æŒ‰æŒç»­å‘å£° ğŸ‘‡</div>
            <div class="visualizer" id="visualizer">
                <div class="wave" id="wave"></div>
            </div>
            <button class="drum-loop-btn" id="drumLoopBtn">ğŸµ å¼€å¯é¼“ç‚¹å¾ªç¯</button>
        </section>
    </div>

    <script>
        // ä¸“ä¸šéŸ³é¢‘å¼•æ“
        class ProfessionalAudioEngine {
            constructor() {
                this.audioContext = null;
                this.reverbNode = null;
                this.delayNode = null;
                this.analyser = null;
                this.reverbAmount = 0.6;
                this.delayTime = 0.3;
                this.feedback = 0.5;
                this.isInitialized = false;
                this.visualizationData = null;
            }
            
            async initialize() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    
                    // åˆ›å»ºæ•ˆæœå™¨é“¾
                    this.createEffectsChain();
                    
                    // åˆ›å»ºéŸ³é¢‘åˆ†æå™¨ç”¨äºå¯è§†åŒ–
                    this.analyser = this.audioContext.createAnalyser();
                    this.analyser.fftSize = 256;
                    this.analyser.connect(this.audioContext.destination);
                    
                    this.isInitialized = true;
                    console.log('ä¸“ä¸šéŸ³é¢‘å¼•æ“åˆå§‹åŒ–å®Œæˆ');
                    return true;
                } catch (error) {
                    console.error('éŸ³é¢‘å¼•æ“åˆå§‹åŒ–å¤±è´¥:', error);
                    return false;
                }
            }
            
            createEffectsChain() {
                // æ··å“æ•ˆæœå™¨
                this.reverbNode = this.audioContext.createConvolver();
                this.createReverbBuffer();
                
                // å»¶è¿Ÿæ•ˆæœå™¨ï¼ˆå›å£°ï¼‰
                this.delayNode = this.audioContext.createDelay();
                this.delayNode.delayTime.value = this.delayTime;
                
                // å»¶è¿Ÿåé¦ˆ
                const feedbackGain = this.audioContext.createGain();
                feedbackGain.gain.value = this.feedback;
                
                // è¿æ¥æ•ˆæœå™¨é“¾ï¼šéŸ³æº â†’ å»¶è¿Ÿ â†’ æ··å“ â†’ è¾“å‡º
                this.delayNode.connect(feedbackGain);
                feedbackGain.connect(this.delayNode);
                this.delayNode.connect(this.reverbNode);
            }
            
            createReverbBuffer() {
                // åˆ›å»ºäººå·¥æ··å“è„‰å†²å“åº”
                const length = this.audioContext.sampleRate * 2;
                const impulse = this.audioContext.createBuffer(2, length, this.audioContext.sampleRate);
                const left = impulse.getChannelData(0);
                const right = impulse.getChannelData(1);
                
                for (let i = 0; i < length; i++) {
                    left[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / length, 2);
                    right[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / length, 2);
                }
                
                this.reverbNode.buffer = impulse;
            }
            
            updateReverb(amount) {
                this.reverbAmount = amount;
            }
            
            updateDelay(time) {
                if (this.delayNode) {
                    this.delayNode.delayTime.value = time;
                }
            }
            
            updateFeedback(feedback) {
                this.feedback = feedback * 0.2; // è½¬æ¢ä¸ºå¢ç›Šå€¼
            }
            
            // ç”Ÿæˆä¸“ä¸šæ‰“å‡»ä¹éŸ³è‰²
            createInstrumentSound(type) {
                if (!this.isInitialized) return null;
                
                const now = this.audioContext.currentTime;
                const duration = this.getDurationForInstrument(type);
                
                // åˆ›å»ºéŸ³æº
                const oscillator = this.audioContext.createOscillator();
                const noiseBuffer = this.createNoiseBuffer(duration);
                const noiseSource = this.audioContext.createBufferSource();
                noiseSource.buffer = noiseBuffer;
                
                // åˆ›å»ºåŒ…ç»œ
                const gainNode = this.audioContext.createGain();
                const filter = this.audioContext.createBiquadFilter();
                
                // é…ç½®ä¸åŒä¹å™¨çš„éŸ³è‰²
                this.configureInstrument(type, oscillator, filter, gainNode, now, duration);
                
                // è¿æ¥æ•ˆæœå™¨é“¾
                if (type.includes('é¼“') || type === 'å¤§é”£' || type === 'çˆ†ç‚¸') {
                    // é¼“ç±»ä¹å™¨ï¼šåªç»è¿‡æ··å“
                    noiseSource.connect(gainNode);
                    gainNode.connect(this.reverbNode);
                    this.reverbNode.connect(this.audioContext.destination);
                    noiseSource.start(now);
                } else if (type === 'é•²' || type === 'é“ƒé“›') {
                    // é‡‘å±ä¹å™¨ï¼šç»è¿‡å»¶è¿Ÿå’Œæ··å“
                    oscillator.connect(filter);
                    filter.connect(gainNode);
                    gainNode.connect(this.delayNode);
                    this.delayNode.connect(this.reverbNode);
                    this.reverbNode.connect(this.audioContext.destination);
                    oscillator.start(now);
                } else {
                    // å…¶ä»–ä¹å™¨
                    oscillator.connect(filter);
                    filter.connect(gainNode);
                    gainNode.connect(this.reverbNode);
                    this.reverbNode.connect(this.analyser);
                    this.reverbNode.connect(this.audioContext.destination);
                    oscillator.start(now);
                }
                
                // åœæ­¢éŸ³æº
                setTimeout(() => {
                    try {
                        oscillator.stop();
                        if (noiseSource) noiseSource.stop();
                    } catch(e) {}
                }, duration * 1000);
                
                // æ›´æ–°å¯è§†åŒ–
                this.updateVisualization();
                
                return { oscillator, gainNode, noiseSource };
            }
            
            configureInstrument(type, osc, filter, gain, now, duration) {
                const configs = {
                    'æœ¨é±¼': { freq: 800, type: 'sine', filterFreq: 1000, q: 5 },
                    'å“æ¿': { freq: 1200, type: 'square', filterFreq: 2000, q: 2 },
                    'é“ƒé“›': { freq: 1567, type: 'sine', filterFreq: 3000, q: 10 },
                    'å°é¼“': { freq: 150, type: 'sawtooth', filterFreq: 800, q: 3 },
                    'æ²™é”¤': { freq: 500, type: 'square', filterFreq: 1500, q: 1 },
                    'æ‹æ¿': { freq: 600, type: 'square', filterFreq: 1200, q: 4 },
                    'é•²': { freq: 2000, type: 'sawtooth', filterFreq: 4000, q: 0.5 },
                    'é“ƒé¼“': { freq: 800, type: 'triangle', filterFreq: 2000, q: 2 },
                    'æ¬¢å‘¼': { freq: 600, type: 'sine', filterFreq: 1000, q: 1 },
                    'å¤§é”£': { freq: 300, type: 'sine', filterFreq: 500, q: 0.5 },
                    'ä½éŸ³é¼“': { freq: 100, type: 'sawtooth', filterFreq: 400, q: 2 },
                    'çˆ†ç‚¸': { freq: 80, type: 'sawtooth', filterFreq: 300, q: 0.3 }
                };
                
                const config = configs[type] || configs['æœ¨é±¼'];
                
                osc.type = config.type;
                osc.frequency.setValueAtTime(config.freq, now);
                if (type === 'é“ƒé“›') {
                    osc.frequency.exponentialRampToValueAtTime(config.freq * 0.5, now + duration);
                }
                
                filter.type = 'bandpass';
                filter.frequency.setValueAtTime(config.filterFreq, now);
                filter.Q.setValueAtTime(config.q, now);
                
                // åŠ¨æ€åŒ…ç»œ
                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(0.7, now + 0.01);
                gain.gain.exponentialRampToValueAtTime(0.001, now + duration);
            }
            
            createNoiseBuffer(duration) {
                const bufferSize = this.audioContext.sampleRate * duration;
                const buffer = this.audioContext.createBuffer(1, bufferSize, this.audioContext.sampleRate);
                const data = buffer.getChannelData(0);
                
                for (let i = 0; i < bufferSize; i++) {
                    data[i] = Math.random() * 2 - 1;
                }
                
                return buffer;
            }
            
            getDurationForInstrument(type) {
                const durations = {
                    'æœ¨é±¼': 0.2, 'å“æ¿': 0.15, 'é“ƒé“›': 1.5,
                    'å°é¼“': 0.3, 'æ²™é”¤': 0.4, 'æ‹æ¿': 0.25,
                    'é•²': 1.2, 'é“ƒé¼“': 0.6, 'æ¬¢å‘¼': 0.8,
                    'å¤§é”£': 2.0, 'ä½éŸ³é¼“': 0.5, 'çˆ†ç‚¸': 1.0
                };
                return durations[type] || 0.5;
            }
            
            updateVisualization() {
                if (!this.analyser) return;
                
                const dataArray = new Uint8Array(this.analyser.frequencyBinCount);
                this.analyser.getByteFrequencyData(dataArray);
                this.visualizationData = dataArray;
            }
            
            getVisualizationData() {
                return this.visualizationData;
            }
        }
        
        // ä¸»ç¨‹åº
        const audioEngine = new ProfessionalAudioEngine();
        let currentRole = '';
        let currentInstrument = '';
        let isDrumLoopPlaying = false;
        let drumLoopSources = [];
        let visualizationInterval;
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            // æ•ˆæœå™¨æ§åˆ¶
            setupEffectControls();
            
            // æµ‹è¯•æŒ‰é’®
            document.getElementById('testSoundBtn').addEventListener('click', async () => {
                await audioEngine.initialize();
                playTestSound();
            });
            
            // è§’è‰²é€‰æ‹©
            setupRoleSelection();
            
            // å…¶ä»–äº‹ä»¶
            document.getElementById('homeBtn').addEventListener('click', goHome);
            document.getElementById('drumLoopBtn').addEventListener('click', toggleDrumLoop);
            
            // æ¼”å¥ç•Œé¢ç‚¹å‡»
            document.getElementById('performanceScreen').addEventListener('click', (e) => {
                if (e.target.id === 'drumLoopBtn' || e.target.id === 'homeBtn') return;
                playCurrentInstrument();
            });
            
            // é•¿æŒ‰æ”¯æŒ
            let touchTimer;
            document.getElementById('performanceScreen').addEventListener('touchstart', (e) => {
                if (e.target.id === 'drumLoopBtn' || e.target.id === 'homeBtn') return;
                touchTimer = setTimeout(() => {
                    playCurrentInstrument();
                    // è¿ç»­æ’­æ”¾
                    const interval = setInterval(() => playCurrentInstrument(), 200);
                    // åœæ­¢é•¿æŒ‰
                    const stopLongPress = () => {
                        clearInterval(interval);
                        document.removeEventListener('touchend', stopLongPress);
                    };
                    document.addEventListener('touchend', stopLongPress);
                }, 300);
            });
            
            document.getElementById('performanceScreen').addEventListener('touchend', () => {
                clearTimeout(touchTimer);
            });
            
            // å¯åŠ¨å¯è§†åŒ–
            startVisualization();
        });
        
        function setupEffectControls() {
            const reverbSlider = document.getElementById('reverbSlider');
            const delaySlider = document.getElementById('delaySlider');
            const feedbackSlider = document.getElementById('feedbackSlider');
            
            reverbSlider.addEventListener('input', (e) => {
                const value = parseFloat(e.target.value);
                document.getElementById('reverbValue').textContent = value.toFixed(1);
                if (audioEngine.isInitialized) {
                    audioEngine.updateReverb(value);
                }
            });
            
            delaySlider.addEventListener('input', (e) => {
                const value = parseFloat(e.target.value);
                document.getElementById('delayValue').textContent = value.toFixed(1) + 's';
                if (audioEngine.isInitialized) {
                    audioEngine.updateDelay(value);
                }
            });
            
            feedbackSlider.addEventListener('input', (e) => {
                const value = parseInt(e.target.value);
                document.getElementById('feedbackValue').textContent = value;
                if (audioEngine.isInitialized) {
                    audioEngine.updateFeedback(value);
                }
            });
        }
        
        function setupRoleSelection() {
            document.querySelectorAll('.role-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    currentRole = this.dataset.role;
                    document.querySelectorAll('.role-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    document.getElementById('roleScreen').style.display = 'none';
                    const instrumentScreen = document.getElementById('instrumentScreen');
                    instrumentScreen.style.display = 'block';
                    document.getElementById('instrumentTitle').textContent = `ã€${currentRole}ã€‘é€‰æ‹©ä¹å™¨`;
                    
                    const instruments = {
                        'ç”²': ['æœ¨é±¼', 'å“æ¿', 'é“ƒé“›'],
                        'ä¹™': ['å°é¼“', 'æ²™é”¤', 'æ‹æ¿'],
                        'ä¸™': ['é•²', 'é“ƒé¼“', 'æ¬¢å‘¼'],
                        'ä¸': ['å¤§é”£', 'ä½éŸ³é¼“', 'çˆ†ç‚¸']
                    };
                    
                    const instrumentList = document.getElementById('instrumentList');
                    instrumentList.innerHTML = '';
                    instruments[currentRole].forEach(instrument => {
                        const btn = document.createElement('button');
                        btn.className = 'instrument-btn';
                        btn.textContent = instrument;
                        btn.addEventListener('click', function() {
                            currentInstrument = instrument;
                            startPerformance();
                        });
                        instrumentList.appendChild(btn);
                    });
                });
            });
        }
        
        async function playTestSound() {
            if (!audioEngine.isInitialized) return;
            
            // æ’­æ”¾æµ‹è¯•åºåˆ—ï¼šæœ¨é±¼ã€é“ƒé“›ã€å¤§é”£
            const instruments = ['æœ¨é±¼', 'é“ƒé“›', 'å¤§é”£'];
            instruments.forEach((inst, index) => {
                setTimeout(() => {
                    audioEngine.createInstrumentSound(inst);
                }, index * 600);
            });
            
            document.getElementById('testSoundBtn').textContent = 'ğŸµ æµ‹è¯•é€šè¿‡ï¼æ··å“æ•ˆæœå·²å¯ç”¨';
            document.getElementById('testSoundBtn').style.background = 'linear-gradient(135deg, #43e97b, #38f9d7)';
        }
        
        function playCurrentInstrument() {
            if (!audioEngine.isInitialized || !currentInstrument) return;
            audioEngine.createInstrumentSound(currentInstrument);
        }
        
        function startPerformance() {
            document.getElementById('instrumentScreen').style.display = 'none';
            const perfScreen = document.getElementById('performanceScreen');
            perfScreen.style.display = 'block';
            document.getElementById('currentRoleDisplay').textContent = 
                `${currentRole} Â· ${currentInstrument}`;
            
            if (!audioEngine.isInitialized) {
                audioEngine.initialize();
            }
        }
        
        function goHome() {
            stopDrumLoop();
            document.getElementById('performanceScreen').style.display = 'none';
            document.getElementById('roleScreen').style.display = 'grid';
            document.getElementById('instrumentScreen').style.display = 'none';
        }
        
        function toggleDrumLoop() {
            if (!isDrumLoopPlaying) {
                startDrumLoop();
            } else {
                stopDrumLoop();
            }
        }
        
        function startDrumLoop() {
            if (!audioEngine.isInitialized) return;
            
            isDrumLoopPlaying = true;
            const btn = document.getElementById('drumLoopBtn');
            btn.textContent = 'â¹ï¸ å…³é—­é¼“ç‚¹å¾ªç¯';
            btn.style.background = 'linear-gradient(135deg, #ff416c, #ff4b2b)';
            
            // åˆ›å»ºé¼“ç‚¹å¾ªç¯
            const bpm = 120;
            const interval = 60000 / bpm / 2; // åŠæ‹
            
            let beat = 0;
            drumLoopSources = [];
            
            const loop = setInterval(() => {
                const now = audioEngine.audioContext.currentTime;
                
                // å¼ºæ‹
                if (beat % 4 === 0) {
                    const sound = audioEngine.createInstrumentSound('ä½éŸ³é¼“');
                    if (sound) drumLoopSources.push(sound);
                }
                // å¼±æ‹
                else if (beat % 2 === 0) {
                    const sound = audioEngine.createInstrumentSound('å°é¼“');
                    if (sound) drumLoopSources.push(sound);
                }
                
                beat = (beat + 1) % 8;
            }, interval);
            
            // å­˜å‚¨å¾ªç¯ID
            drumLoopSources.loopId = loop;
        }
        
        function stopDrumLoop() {
            if (!isDrumLoopPlaying) return;
            
            isDrumLoopPlaying = false;
            const btn = document.getElementById('drumLoopBtn');
            btn.textContent = 'ğŸµ å¼€å¯é¼“ç‚¹å¾ªç¯';
            btn.style.background = 'linear-gradient(135deg, #ff8a00, #e52e71)';
            
            // åœæ­¢å¾ªç¯
            if (drumLoopSources.loopId) {
                clearInterval(drumLoopSources.loopId);
            }
            
            // åœæ­¢æ‰€æœ‰å£°éŸ³
            drumLoopSources.forEach(source => {
                try {
                    if (source.oscillator) source.oscillator.stop();
                    if (source.noiseSource) source.noiseSource.stop();
                } catch(e) {}
            });
            
            drumLoopSources = [];
        }
        
        function startVisualization() {
            const wave = document.getElementById('wave');
            let animationId;
            
            function animate() {
                if (audioEngine.isInitialized && audioEngine.getVisualizationData) {
                    const data = audioEngine.getVisualizationData();
                    if (data) {
                        // è®¡ç®—å¹³å‡èƒ½é‡
                        let sum = 0;
                        for (let i = 0; i < 32; i++) {
                            sum += data[i];
                        }
                        const avg = sum / 32 / 128; // å½’ä¸€åŒ–åˆ°0-1
                        
                        // åº”ç”¨æ³¢å½¢æ•ˆæœ
                        wave.style.height = `${30 + avg * 30}px`;
                        wave.style.opacity = 0.3 + avg * 0.7;
                        
                        // æ³¢çº¹æ•ˆæœ
                        wave.style.transform = `scaleY(${1 + avg * 0.5})`;
                    }
                }
                animationId = requestAnimationFrame(animate);
            }
            
            animate();
            
            // æ¸…ç†
            return () => cancelAnimationFrame(animationId);
        }
        
        // é˜²æ­¢å±å¹•ä¼‘çœ 
        if ('wakeLock' in navigator) {
            navigator.wakeLock.request('screen').catch(() => {});
        }
    </script>
</body>
</html>

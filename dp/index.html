<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸‰å¥åŠç»ˆææ¼”å‡ºç³»ç»Ÿ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: "Microsoft YaHei", sans-serif;
            background: linear-gradient(180deg, #0f0c29, #302b63, #24243e);
            color: white;
            min-height: 100vh;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }
        
        /* é¡¶éƒ¨ï¼šç³»ç»ŸçŠ¶æ€ */
        .system-status {
            text-align: center;
            padding: 10px;
            margin-bottom: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            border: 2px solid rgba(255,215,0,0.3);
        }
        
        /* ç¬¬ä¸€åŒºï¼šéŸ³æ§åŒºï¼ˆ4ä¸ªæ§åˆ¶ï¼‰ */
        .audio-controls {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 20px;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
        }
        
        .control-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            padding: 10px;
        }
        
        /* ç‚«é…·ç‰¹æ•ˆå¼€å…³ */
        .fx-toggle {
            width: 60px;
            height: 30px;
            background: linear-gradient(90deg, #ff0080, #ff8c00);
            border-radius: 15px;
            position: relative;
            cursor: pointer;
            border: none;
        }
        
        .fx-toggle::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
        }
        
        .fx-toggle.on::after {
            left: 33px;
            background: #00ff88;
            box-shadow: 0 0 10px #00ff88;
        }
        
        /* ç¬¬äºŒåŒºï¼šæ‰“å‡»ä¹æŒ‰é’®ï¼ˆ6ä¸ªç«–æ’ï¼‰ */
        .instrument-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .instrument-btn {
            flex: 1;
            min-height: 70px;
            border: none;
            border-radius: 12px;
            font-size: 1.3rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .instrument-btn:active {
            transform: scale(0.98);
        }
        
        .instrument-btn.playing {
            animation: glow 1s infinite alternate;
        }
        
        @keyframes glow {
            from { box-shadow: 0 0 10px currentColor; }
            to { box-shadow: 0 0 20px currentColor, 0 0 30px currentColor; }
        }
        
        /* æŒ‰é’®é¢œè‰²å’Œç‰¹æ®Šå®šä½ */
        .gong-btn { 
            background: linear-gradient(135deg, #ff6b35, #ff4757);
            color: white;
        }
        
        .drum-btn { 
            background: linear-gradient(135deg, #3742fa, #5352ed);
            color: white;
            margin-top: -5px; /* è®©é”£å’Œå°é¼“æ›´é è¿‘ */
            border-top-left-radius: 0;
            border-top-right-radius: 0;
        }
        
        .cymbal-btn { 
            background: linear-gradient(135deg, #00b894, #00cec9);
            color: white;
        }
        
        .woodblock-btn { 
            background: linear-gradient(135deg, #0984e3, #74b9ff);
            color: white;
        }
        
        .clapper-btn { 
            background: linear-gradient(135deg, #e84393, #fd79a8);
            color: white;
        }
        
        .bell-btn { 
            background: linear-gradient(135deg, #fdcb6e, #ffeaa7);
            color: #333;
        }
        
        /* ç¬¬ä¸‰åŒºï¼šåº•éƒ¨è¯•éªŒå¨±ä¹åŒº */
        .fun-zone {
            background: linear-gradient(135deg, #6a11cb, #2575fc);
            border-radius: 15px;
            padding: 15px;
            margin-top: 10px;
            border: 3px dashed rgba(255,255,255,0.3);
        }
        
        .fun-title {
            text-align: center;
            font-size: 1.2rem;
            color: #ffd166;
            margin-bottom: 15px;
            text-shadow: 0 0 10px rgba(255,209,102,0.5);
        }
        
        .fun-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        .fun-btn {
            padding: 15px 5px;
            border: none;
            border-radius: 8px;
            background: rgba(255,255,255,0.15);
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }
        
        .fun-btn:active {
            background: rgba(255,255,255,0.3);
            transform: scale(0.95);
        }
        
        /* ç¬¬å››åŒºï¼šå®éªŒåŒº */
        .experiment-zone {
            background: linear-gradient(135deg, #ff6b6b, #ffd166);
            border-radius: 15px;
            padding: 15px;
            margin-top: 10px;
            border: 3px solid rgba(255,255,255,0.3);
        }
        
        .experiment-title {
            text-align: center;
            font-size: 1.2rem;
            color: #1a1a2e;
            margin-bottom: 15px;
            text-shadow: 0 0 10px rgba(255,255,255,0.5);
        }
        
        .experiment-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 8px;
        }
        
        .experiment-btn {
            padding: 12px 5px;
            border: none;
            border-radius: 8px;
            background: rgba(26, 26, 46, 0.8);
            color: white;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }
        
        .experiment-btn:active {
            background: rgba(26, 26, 46, 1);
            transform: scale(0.95);
            box-shadow: 0 0 15px #ffd166;
        }
        
        /* éŸ³é‡æ¡ç¾åŒ– */
        .volume-slider {
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            background: linear-gradient(90deg, #1a1a2e, #4361ee);
            border-radius: 4px;
            margin: 5px 0;
        }
        
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #4361ee;
            border: 2px solid white;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(67, 97, 238, 0.8);
        }
        
        /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-loading { background: #fbbf24; animation: blink 1s infinite; }
        .status-ready { background: #10b981; }
        .status-error { background: #ef4444; }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        /* å“åº”å¼è°ƒæ•´ */
        @media (max-height: 700px) {
            .instrument-btn {
                min-height: 60px;
                font-size: 1.1rem;
            }
            .fun-buttons {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- ç³»ç»ŸçŠ¶æ€ -->
    <div class="system-status">
        <h2>ğŸ­ ä¸‰å¥åŠç»ˆææ¼”å‡ºç³»ç»Ÿ</h2>
        <div id="systemStatus">
            <span class="status-indicator status-loading"></span> æ­£åœ¨åˆå§‹åŒ–...
        </div>
    </div>
    
    <!-- ç¬¬ä¸€åŒºï¼šéŸ³æ§åŒºï¼ˆ4ä¸ªæ§åˆ¶ï¼‰ -->
    <div class="audio-controls">
        <!-- 1. éŸ³é‡æ§åˆ¶ -->
        <div class="control-item">
            <div style="font-size: 1.5rem;">ğŸ”Š</div>
            <div>æ€»éŸ³é‡</div>
            <input type="range" min="20" max="100" value="80" class="volume-slider" id="masterVolume">
            <div id="volumeValue">80%</div>
        </div>
        
        <!-- 2. é•²å£°éŸ³é‡åŠ å¼º -->
        <div class="control-item">
            <div style="font-size: 1.5rem;">ğŸ’¥</div>
            <div>é•²å£°åŠ å¼º</div>
            <input type="range" min="100" max="300" value="200" class="volume-slider" id="cymbalBoost">
            <div id="cymbalValue">200%</div>
        </div>
        
        <!-- 3. ç‚«é…·ç‰¹æ•ˆå¼€å…³ -->
        <div class="control-item">
            <div style="font-size: 1.5rem;">âœ¨</div>
            <div>èˆå°ç‰¹æ•ˆ</div>
            <button class="fx-toggle" id="fxToggle"></button>
            <div id="fxStatus">å…³</div>
        </div>
        
        <!-- 4. æ¬¢åº†é”£é¼“æ—¶é•¿ -->
        <div class="control-item">
            <div style="font-size: 1.5rem;">â±ï¸</div>
            <div>é”£é¼“æ—¶é•¿</div>
            <input type="range" min="4" max="12" step="0.5" value="8" class="volume-slider" id="drumDuration">
            <div id="durationValue">8ç§’</div>
        </div>
    </div>
    
    <!-- ç¬¬äºŒåŒºï¼šæ‰“å‡»ä¹æŒ‰é’®ï¼ˆ6ä¸ªç«–æ’ï¼‰ -->
    <div class="instrument-panel">
        <button class="instrument-btn gong-btn" id="gongBtn">
            <span style="font-size: 1.8rem;">ğŸ¥</span>
            <span>å¤§é”£</span>
            <small style="font-size: 0.8rem; opacity: 0.8;">çœŸå®å½•éŸ³</small>
        </button>
        
        <button class="instrument-btn drum-btn" id="drumBtn">
            <span style="font-size: 1.8rem;">ğŸ¯</span>
            <span>æ¬¢åº†é”£é¼“</span>
            <small style="font-size: 0.8rem; opacity: 0.8;">8ç§’å¾ªç¯</small>
        </button>
        
        <button class="instrument-btn cymbal-btn" id="cymbalBtn">
            <span style="font-size: 1.8rem;">ğŸ’¥</span>
            <span>å¤§é•²</span>
            <small style="font-size: 0.8rem; opacity: 0.8;">é•²ç‰‡éŸ³æ•ˆ</small>
        </button>
        
        <button class="instrument-btn woodblock-btn" id="woodblockBtn">
            <span style="font-size: 1.8rem;">ğŸµ</span>
            <span>æœ¨é±¼</span>
            <small style="font-size: 0.8rem; opacity: 0.8;">èŠ‚å¥æ‰“ç‚¹</small>
        </button>
        
        <button class="instrument-btn clapper-btn" id="clapperBtn">
            <span style="font-size: 1.8rem;">ğŸ‘</span>
            <span>å“æ¿</span>
            <small style="font-size: 0.8rem; opacity: 0.8;">æ¸…è„†æ‹æ‰“</small>
        </button>
        
        <button class="instrument-btn bell-btn" id="bellBtn">
            <span style="font-size: 1.8rem;">ğŸ””</span>
            <span>é“ƒé“›</span>
            <small style="font-size: 0.8rem; opacity: 0.8;">è£…é¥°éŸ³</small>
        </button>
    </div>
    
    <!-- ç¬¬ä¸‰åŒºï¼šåº•éƒ¨è¯•éªŒå¨±ä¹åŒº -->
    <div class="fun-zone">
        <div class="fun-title">ğŸª ä¸‰å¥åŠå¨±ä¹å®éªŒåŒº ğŸª</div>
        <div class="fun-buttons">
            <button class="fun-btn" id="funSurprise">
                <span style="font-size: 1.5rem;">ğŸ¤ª</span>
                çˆ†ç¬‘æ„å¤–
            </button>
            
            <button class="fun-btn" id="funApplause">
                <span style="font-size: 1.5rem;">ğŸ‘</span>
                è§‚ä¼—æ§åœº
            </button>
            
            <button class="fun-btn" id="funDrama">
                <span style="font-size: 1.5rem;">ğŸ­</span>
                æˆå‰§è½¬æŠ˜
            </button>
            
            <button class="fun-btn" id="funFail">
                <span style="font-size: 1.5rem;">ğŸ’¥</span>
                æ¼”ç ¸äº†ï¼
            </button>
            
            <button class="fun-btn" id="funVictory">
                <span style="font-size: 1.5rem;">ğŸ†</span>
                å®Œç¾æ”¶åœº
            </button>
            
            <button class="fun-btn" id="funRandom">
                <span style="font-size: 1.5rem;">ğŸ²</span>
                éšæœºæƒŠå–œ
            </button>
        </div>
    </div>
    
    <!-- ç¬¬å››åŒºï¼šå®éªŒåŒº -->
    <div class="experiment-zone">
        <div class="experiment-title">ğŸ›ï¸ å®éªŒåŒº - æ¼”å‡ºç»“æŸåç‚«é…·ç”¨</div>
        <div class="experiment-buttons" id="experimentButtons">
            <!-- å®éªŒåŒºæŒ‰é’®å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>

    <script>
        // ä¸“ä¸šéŸ³é¢‘ç³»ç»Ÿ
        class UltimatePerformanceSystem {
            constructor() {
                this.audioContext = null;
                this.buffers = {};
                this.activeSources = {};
                this.effectsEnabled = false;
                
                // éŸ³é‡è®¾ç½®
                this.masterVolume = 0.8;
                this.cymbalBoost = 2.0; // 200%
                this.drumDuration = 8.0; // æ¬¢åº†é”£é¼“8ç§’
                
                // æ–‡ä»¶åŠ è½½çŠ¶æ€
                this.fileStatus = {
                    gong: { loaded: false, type: 'çœŸå®å½•éŸ³', file: 'happy-drum.wav' },  // â† ä¿®æ”¹ä¸º happy-drum
                    cymbal: { loaded: false, type: 'çœŸå®å½•éŸ³', file: 'cymbal1.wav' },    // â† ä¿®æ”¹ä¸º cymbal1
                    drum: { loaded: false, type: 'åˆæˆéŸ³æ•ˆ', file: 'N/A' }
                };
                
                // å®éªŒåŒºæ–‡ä»¶åˆ—è¡¨
                this.experimentFiles = [
                    '1427.wav', '3851.wav', '5975.wav', '9722.wav',
                    'amen.mp3', 'bigger-gong.wav', 'cymbal.wav',
                    'drum.wav', 'gong.wav', 'xm2415.wav',
                    'xm2691.wav', 'y2431.wav', 'å¿«æ¿.wav'
                ];
                
                this.init();
            }
            
            async init() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.updateSystemStatus('éŸ³é¢‘å¼•æ“å¯åŠ¨æˆåŠŸ', 'ready');
                    
                    // å¹¶è¡ŒåŠ è½½çœŸå®æ–‡ä»¶å’Œç”ŸæˆåˆæˆéŸ³æ•ˆ
                    await Promise.all([
                        this.loadRealAudio(),
                        this.generateSynthSounds(),
                        this.loadExperimentSounds()  // åŠ è½½å®éªŒåŒºéŸ³æ•ˆ
                    ]);
                    
                    this.updateSystemStatus('ğŸ‰ ç³»ç»Ÿå°±ç»ªï¼å¯ä»¥å¼€å§‹è¡¨æ¼”', 'ready');
                    this.enableAllButtons();
                    
                } catch (error) {
                    this.updateSystemStatus('âŒ åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
                }
            }
            
            // åŠ è½½çœŸå®éŸ³é¢‘æ–‡ä»¶
            async loadRealAudio() {
                const files = [
                    { name: 'gong', url: 'happy-drum.wav' },      // â† ä¿®æ”¹ä¸º happy-drum
                    { name: 'cymbal', url: 'cymbal1.wav' }        // â† ä¿®æ”¹ä¸º cymbal1
                ];
                
                for (const file of files) {
                    try {
                        this.updateFileStatus(file.name, 'loading');
                        const response = await fetch(file.url);
                        
                        if (!response.ok) {
                            throw new Error('æ–‡ä»¶æœªæ‰¾åˆ°');
                        }
                        
                        const arrayBuffer = await response.arrayBuffer();
                        this.buffers[file.name] = await this.audioContext.decodeAudioData(arrayBuffer);
                        this.fileStatus[file.name].loaded = true;
                        this.updateFileStatus(file.name, 'loaded');
                        
                    } catch (error) {
                        console.warn(`${file.name} åŠ è½½å¤±è´¥:`, error);
                        this.generateFallbackSound(file.name);
                        this.updateFileStatus(file.name, 'fallback');
                    }
                }
            }
            
            // ç”ŸæˆåˆæˆéŸ³æ•ˆ
            generateSynthSounds() {
                // æ¬¢åº†é”£é¼“ - 8ç§’ä¸­å›½ç‰¹è‰²
                this.buffers.drum = this.createDrumSound(this.drumDuration);
                
                // åŸºç¡€æ‰“å‡»ä¹
                this.buffers.woodblock = this.createWoodblockSound();
                this.buffers.clapper = this.createClapperSound();
                this.buffers.bell = this.createBellSound();
                
                // å¨±ä¹éŸ³æ•ˆ
                this.generateFunSounds();
            }
            
            // åŠ è½½å®éªŒåŒºéŸ³æ•ˆ
            async loadExperimentSounds() {
                const loadPromises = this.experimentFiles.map(async (file) => {
                    try {
                        const response = await fetch(file);
                        if (response.ok) {
                            const arrayBuffer = await response.arrayBuffer();
                            this.buffers[file] = await this.audioContext.decodeAudioData(arrayBuffer);
                            console.log(`âœ… å®éªŒåŒºåŠ è½½: ${file}`);
                            
                            // åˆ›å»ºå®éªŒåŒºæŒ‰é’®
                            this.createExperimentButton(file);
                        }
                    } catch (error) {
                        console.warn(`âŒ å®éªŒåŒºåŠ è½½å¤±è´¥: ${file}`, error);
                    }
                });
                
                await Promise.all(loadPromises);
                this.updateSystemStatus('ğŸ¯ å®éªŒåŒºéŸ³æ•ˆåŠ è½½å®Œæˆ', 'ready');
            }
            
            // åˆ›å»ºå®éªŒåŒºæŒ‰é’®
            createExperimentButton(fileName) {
                const buttonContainer = document.getElementById('experimentButtons');
                if (!buttonContainer) return;
                
                const button = document.createElement('button');
                button.className = 'experiment-btn';
                button.dataset.file = fileName;
                
                // è®¾ç½®æŒ‰é’®å›¾æ ‡
                let emoji = 'ğŸµ';
                if (fileName.includes('gong')) emoji = 'ğŸ¥';
                if (fileName.includes('cymbal')) emoji = 'ğŸ’¥';
                if (fileName.includes('drum')) emoji = 'ğŸ¯';
                if (fileName.includes('å¿«æ¿')) emoji = 'ğŸ¼';
                if (fileName.includes('amen')) emoji = 'ğŸ™';
                if (/^\d+\.wav$/.test(fileName)) emoji = 'ğŸ²';
                
                // æ˜¾ç¤ºæ–‡ä»¶åï¼ˆç®€åŒ–ï¼‰
                let displayName = fileName;
                if (fileName.includes('bigger-gong')) displayName = 'å¤§é”£';
                if (fileName.includes('å¿«æ¿')) displayName = 'å¿«æ¿';
                if (fileName === 'amen.mp3') displayName = 'é˜¿é—¨';
                
                button.innerHTML = `
                    <span style="font-size: 1.2rem;">${emoji}</span>
                    <span>${displayName.replace('.wav', '').replace('.mp3', '')}</span>
                `;
                
                button.addEventListener('click', () => {
                    this.playExperimentSound(fileName);
                });
                
                buttonContainer.appendChild(button);
            }
            
            // æ’­æ”¾/åœæ­¢ä¹å™¨
            toggleInstrument(type) {
                const btn = document.getElementById(`${type}Btn`);
                
                // å¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œåœæ­¢å®ƒ
                if (this.activeSources[type]) {
                    this.stopSound(type);
                    btn.classList.remove('playing');
                    return false;
                }
                
                // å¦åˆ™å¼€å§‹æ’­æ”¾
                this.playSound(type);
                btn.classList.add('playing');
                return true;
            }
            
            // æ’­æ”¾éŸ³æ•ˆ
            playSound(type, isFunEffect = false) {
                const buffer = this.buffers[type];
                if (!buffer) {
                    console.error(`éŸ³æ•ˆæœªåŠ è½½: ${type}`);
                    return;
                }
                
                const source = this.audioContext.createBufferSource();
                source.buffer = buffer;
                
                // åˆ›å»ºæ•ˆæœé“¾
                const gainNode = this.audioContext.createGain();
                let volume = this.masterVolume;
                
                // éŸ³é‡è°ƒæ•´
                if (type === 'cymbal') {
                    volume *= this.cymbalBoost;
                }
                
                if (this.effectsEnabled && !isFunEffect) {
                    // æ·»åŠ ç‰¹æ•ˆå¤„ç†
                    const filter = this.audioContext.createBiquadFilter();
                    filter.type = 'highpass';
                    filter.frequency.value = 100;
                    
                    const compressor = this.audioContext.createDynamicsCompressor();
                    
                    source.connect(filter);
                    filter.connect(compressor);
                    compressor.connect(gainNode);
                    
                } else {
                    source.connect(gainNode);
                }
                
                gainNode.connect(this.audioContext.destination);
                gainNode.gain.value = volume;
                
                // å­˜å‚¨å¼•ç”¨
                this.activeSources[type] = { source, gainNode, type };
                
                // æ’­æ”¾ç»“æŸå¤„ç†
                source.onended = () => {
                    delete this.activeSources[type];
                    const btn = document.getElementById(`${type}Btn`);
                    if (btn) btn.classList.remove('playing');
                };
                
                source.start();
                
                // æ¬¢åº†é”£é¼“é™æ—¶åœæ­¢
                if (type === 'drum') {
                    setTimeout(() => {
                        if (this.activeSources[type]) {
                            this.stopSound(type);
                        }
                    }, this.drumDuration * 1000);
                }
            }
            
            // æ’­æ”¾å®éªŒåŒºéŸ³æ•ˆ
            playExperimentSound(fileName) {
                const buffer = this.buffers[fileName];
                if (!buffer) {
                    console.warn(`å®éªŒåŒºéŸ³æ•ˆæœªåŠ è½½: ${fileName}`);
                    return;
                }
                
                const source = this.audioContext.createBufferSource();
                source.buffer = buffer;
                
                const gainNode = this.audioContext.createGain();
                source.connect(gainNode);
                gainNode.connect(this.audioContext.destination);
                gainNode.gain.value = this.masterVolume;
                
                source.start();
                
                // æ·»åŠ ç‚«é…·ç‰¹æ•ˆ
                this.addExperimentVisual(fileName);
            }
            
            // åœæ­¢éŸ³æ•ˆ
            stopSound(type) {
                const sound = this.activeSources[type];
                if (sound) {
                    try {
                        sound.source.stop();
                    } catch (e) {}
                    delete this.activeSources[type];
                }
                const btn = document.getElementById(`${type}Btn`);
                if (btn) btn.classList.remove('playing');
            }
            
            // åœæ­¢æ‰€æœ‰éŸ³æ•ˆ
            stopAll() {
                Object.keys(this.activeSources).forEach(type => {
                    this.stopSound(type);
                });
            }
            
            // ç”Ÿæˆå¨±ä¹éŸ³æ•ˆ
            generateFunSounds() {
                // çˆ†ç¬‘æ„å¤–
                this.buffers.surprise = this.createSurpriseSound();
                
                // è§‚ä¼—æŒå£°
                this.buffers.applause = this.createApplauseSound();
                
                // æˆå‰§è½¬æŠ˜
                this.buffers.drama = this.createDramaSound();
                
                // æ¼”ç ¸äº†
                this.buffers.fail = this.createFailSound();
                
                // èƒœåˆ©éŸ³æ•ˆ
                this.buffers.victory = this.createVictorySound();
            }
            
            // æ’­æ”¾å¨±ä¹éŸ³æ•ˆ
            playFunEffect(type) {
                if (!this.effectsEnabled) {
                    this.enableEffects(true); // è‡ªåŠ¨å¼€å¯ç‰¹æ•ˆ
                }
                
                this.playSound(type, true);
                
                // é¢å¤–è§†è§‰æ•ˆæœ
                this.addVisualEffect(type);
            }
            
            // æ·»åŠ è§†è§‰æ•ˆæœ
            addVisualEffect(type) {
                const effects = {
                    surprise: { color: '#ff00ff', emoji: 'ğŸ¤ª' },
                    applause: { color: '#00ff00', emoji: 'ğŸ‘' },
                    drama: { color: '#ff9900', emoji: 'ğŸ­' },
                    fail: { color: '#ff0000', emoji: 'ğŸ’¥' },
                    victory: { color: '#ffff00', emoji: 'ğŸ†' }
                };
                
                const effect = effects[type];
                if (effect) {
                    const flash = document.createElement('div');
                    flash.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: radial-gradient(circle, ${effect.color}40, transparent 70%);
                        pointer-events: none;
                        z-index: 1000;
                        animation: flashEffect 0.5s ease-out;
                    `;
                    
                    document.body.appendChild(flash);
                    setTimeout(() => flash.remove(), 500);
                }
            }
            
            // æ·»åŠ å®éªŒåŒºè§†è§‰ç‰¹æ•ˆ
            addExperimentVisual(fileName) {
                const colors = ['#ff006e', '#8338ec', '#3a86ff', '#fb5607', '#ffbe0b'];
                const color = colors[Math.floor(Math.random() * colors.length)];
                
                const flash = document.createElement('div');
                flash.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    width: 200px;
                    height: 200px;
                    background: radial-gradient(circle, ${color}80, transparent 70%);
                    pointer-events: none;
                    z-index: 1000;
                    transform: translate(-50%, -50%);
                    animation: experimentFlash 1s ease-out;
                    border-radius: 50%;
                `;
                
                // æ·»åŠ æ–‡ä»¶åæ˜¾ç¤º
                const text = document.createElement('div');
                text.textContent = fileName.replace('.wav', '').replace('.mp3', '');
                text.style.cssText = `
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    color: white;
                    font-weight: bold;
                    text-shadow: 0 0 10px black;
                    font-size: 14px;
                    text-align: center;
                    padding: 0 5px;
                `;
                flash.appendChild(text);
                
                document.body.appendChild(flash);
                setTimeout(() => flash.remove(), 1000);
            }
            
            // éŸ³æ•ˆç”Ÿæˆå‡½æ•° - åˆ›å»ºä¸­å›½ç‰¹è‰²æ¬¢åº†é”£é¼“
            createDrumSound(duration) {
                const buffer = this.audioContext.createBuffer(2, 
                    this.audioContext.sampleRate * duration, 
                    this.audioContext.sampleRate);
                const left = buffer.getChannelData(0);
                const right = buffer.getChannelData(1);
                
                // åˆ›å»ºä¸­å›½ç‰¹è‰²æ¬¢åº†é”£é¼“èŠ‚å¥
                const bpm = 100; // ç¨æ…¢çš„æ¬¢åº†èŠ‚å¥
                const beatInterval = 60 / bpm;
                
                for (let i = 0; i < buffer.length; i++) {
                    const t = i / this.audioContext.sampleRate;
                    let sample = 0;
                    
                    // ä¸»é”£å£°ï¼ˆæ¯å°èŠ‚ç¬¬ä¸€æ‹ï¼‰
                    if (Math.floor(t / beatInterval) % 4 === 0 && t % beatInterval < 0.1) {
                        const envelope = Math.exp(-(t % beatInterval) * 20);
                        const freq = 180 * Math.exp(-(t % beatInterval) * 8);
                        sample += Math.sin(t * freq * Math.PI * 2) * envelope * 0.8;
                    }
                    
                    // é¼“ç‚¹ä¼´å¥ï¼ˆç¬¬äºŒã€å››æ‹ï¼‰
                    if ((Math.floor(t / beatInterval) % 4 === 1 || Math.floor(t / beatInterval) % 4 === 3) 
                        && t % beatInterval < 0.05) {
                        const envelope = Math.exp(-(t % beatInterval) * 40);
                        sample += (Math.random() * 2 - 1) * envelope * 0.4; // åŠ å…¥å™ªéŸ³æ¨¡æ‹Ÿé¼“çš®
                    }
                    
                    // é•²ç‰‡ç‚¹ç¼€ï¼ˆæ¯æ‹ï¼‰
                    if (t % beatInterval < 0.02) {
                        const envelope = Math.exp(-(t % beatInterval) * 60);
                        sample += Math.sin(t * 2000 * Math.PI * 2) * envelope * 0.3;
                    }
                    
                    left[i] = sample * 0.9;
                    right[i] = sample * 0.85;
                }
                
                return buffer;
            }
            
            createWoodblockSound() {
                const duration = 0.3;
                const buffer = this.audioContext.createBuffer(1, 
                    this.audioContext.sampleRate * duration, 
                    this.audioContext.sampleRate);
                const data = buffer.getChannelData(0);
                
                for (let i = 0; i < data.length; i++) {
                    const t = i / this.audioContext.sampleRate;
                    data[i] = Math.sin(t * 880 * Math.PI * 2) * Math.exp(-t * 15) * 0.6;
                }
                
                return buffer;
            }
            
            createClapperSound() {
                const duration = 0.2;
                const buffer = this.audioContext.createBuffer(1, 
                    this.audioContext.sampleRate * duration, 
                    this.audioContext.sampleRate);
                const data = buffer.getChannelData(0);
                
                for (let i = 0; i < data.length; i++) {
                    const t = i / this.audioContext.sampleRate;
                    let sample = 0;
                    if (t < 0.02) sample = Math.sin(t * 1200 * Math.PI * 2) * (1 - t * 50);
                    if (t > 0.05 && t < 0.07) sample += Math.sin((t-0.05) * 800 * Math.PI * 2) * (1 - (t-0.05) * 50) * 0.6;
                    data[i] = sample;
                }
                
                return buffer;
            }
            
            createBellSound() {
                const duration = 1.5;
                const buffer = this.audioContext.createBuffer(1, 
                    this.audioContext.sampleRate * duration, 
                    this.audioContext.sampleRate);
                const data = buffer.getChannelData(0);
                
                for (let i = 0; i < data.length; i++) {
                    const t = i / this.audioContext.sampleRate;
                    const env = Math.exp(-t * 2);
                    data[i] = (
                        Math.sin(t * 1046 * Math.PI * 2) * 0.4 +
                        Math.sin(t * 1318 * Math.PI * 2) * 0.3 +
                        Math.sin(t * 1568 * Math.PI * 2) * 0.3
                    ) * env;
                }
                
                return buffer;
            }
            
            generateFallbackSound(type) {
                if (type === 'gong') {
                    this.buffers.gong = this.createGongSound();
                } else if (type === 'cymbal') {
                    this.buffers.cymbal = this.createCymbalSound();
                }
                this.fileStatus[type].loaded = true;
            }
            
            createGongSound() {
                const duration = 3.0;
                const buffer = this.audioContext.createBuffer(2, 
                    this.audioContext.sampleRate * duration, 
                    this.audioContext.sampleRate);
                const left = buffer.getChannelData(0);
                const right = buffer.getChannelData(1);
                
                for (let i = 0; i < buffer.length; i++) {
                    const t = i / this.audioContext.sampleRate;
                    const env = Math.exp(-t * 1.5);
                    const freq = 220;
                    const wave = Math.sin(t * freq * Math.PI * 2) * env;
                    left[i] = wave * 0.7;
                    right[i] = wave * 0.6;
                }
                
                return buffer;
            }
            
            createCymbalSound() {
                const duration = 2.0;
                const buffer = this.audioContext.createBuffer(2, 
                    this.audioContext.sampleRate * duration, 
                    this.audioContext.sampleRate);
                const left = buffer.getChannelData(0);
                const right = buffer.getChannelData(1);
                
                for (let i = 0; i < buffer.length; i++) {
                    const t = i / this.audioContext.sampleRate;
                    const env = Math.exp(-t * 4);
                    const high = Math.sin(t * 2000 * Math.PI * 2) * env;
                    const noise = t < 0.3 ? (Math.random() * 2 - 1) * env * 0.5 : 0;
                    const sample = (high + noise) * 1.5;
                    left[i] = sample;
                    right[i] = sample * 0.9;
                }
                
                return buffer;
            }
            
            // å¨±ä¹éŸ³æ•ˆç”Ÿæˆ
            createSurpriseSound() {
                const duration = 1.5;
                const buffer = this.audioContext.createBuffer(2, 
                    this.audioContext.sampleRate * duration, 
                    this.audioContext.sampleRate);
                const left = buffer.getChannelData(0);
                const right = buffer.getChannelData(1);
                
                for (let i = 0; i < buffer.length; i++) {
                    const t = i / this.audioContext.sampleRate;
                    const slide = 100 + t * 800; // éŸ³è°ƒæ»‘åŠ¨
                    const wave = Math.sin(t * slide * Math.PI * 2) * Math.exp(-t * 3);
                    left[i] = wave * 0.5;
                    right[i] = wave * 0.5;
                }
                
                return buffer;
            }
            
            createApplauseSound() {
                const duration = 3.0;
                const buffer = this.audioContext.createBuffer(2, 
                    this.audioContext.sampleRate * duration, 
                    this.audioContext.sampleRate);
                const left = buffer.getChannelData(0);
                const right = buffer.getChannelData(1);
                
                // æ¨¡æ‹ŸæŒå£°ï¼šéšæœºè„‰å†²
                for (let i = 0; i < buffer.length; i++) {
                    const t = i / this.audioContext.sampleRate;
                    const env = Math.exp(-t * 1.5);
                    
                    // éšæœºæŒå£°è„‰å†²
                    let clap = 0;
                    if (Math.random() < 0.3) { // 30%çš„æ¦‚ç‡æœ‰æŒå£°
                        const phase = Math.random() * Math.PI * 2;
                        clap = Math.sin(t * 500 * Math.PI * 2 + phase) * env * 0.3;
                    }
                    
                    left[i] = clap;
                    right[i] = clap * 0.8;
                }
                
                return buffer;
            }
            
            createDramaSound() {
                const duration = 2.0;
                const buffer = this.audioContext.createBuffer(2, 
                    this.audioContext.sampleRate * duration, 
                    this.audioContext.sampleRate);
                const left = buffer.getChannelData(0);
                const right = buffer.getChannelData(1);
                
                for (let i = 0; i < buffer.length; i++) {
                    const t = i / this.audioContext.sampleRate;
                    const env = Math.exp(-t * 2);
                    const freq = 100 + Math.sin(t * 5) * 50; // é¢¤éŸ³æ•ˆæœ
                    const wave = Math.sin(t * freq * Math.PI * 2) * env;
                    left[i] = wave * 0.6;
                    right[i] = wave * 0.6;
                }
                
                return buffer;
            }
            
            createFailSound() {
                const duration = 1.0;
                const buffer = this.audioContext.createBuffer(2, 
                    this.audioContext.sampleRate * duration, 
                    this.audioContext.sampleRate);
                const left = buffer.getChannelData(0);
                const right = buffer.getChannelData(1);
                
                for (let i = 0; i < buffer.length; i++) {
                    const t = i / this.audioContext.sampleRate;
                    const freq = 200 * Math.exp(-t * 5); // éŸ³è°ƒä¸‹é™
                    const wave = Math.sin(t * freq * Math.PI * 2) * Math.exp(-t * 8);
                    left[i] = wave * 0.7;
                    right[i] = wave * 0.7;
                }
                
                return buffer;
            }
            
            createVictorySound() {
                const duration = 2.0;
                const buffer = this.audioContext.createBuffer(2, 
                    this.audioContext.sampleRate * duration, 
                    this.audioContext.sampleRate);
                const left = buffer.getChannelData(0);
                const right = buffer.getChannelData(1);
                
                // èƒœåˆ©éŸ³é˜¶
                const notes = [523.25, 659.25, 783.99, 1046.50]; // C5, E5, G5, C6
                
                for (let i = 0; i < buffer.length; i++) {
                    const t = i / this.audioContext.sampleRate;
                    let sample = 0;
                    
                    notes.forEach((note, index) => {
                        const noteTime = index * 0.3;
                        if (t >= noteTime && t < noteTime + 0.5) {
                            const env = Math.exp(-(t - noteTime) * 6);
                            sample += Math.sin((t - noteTime) * note * Math.PI * 2) * env * 0.3;
                        }
                    });
                    
                    left[i] = sample;
                    right[i] = sample;
                }
                
                return buffer;
            }
            
            // æ§åˆ¶æ–¹æ³•
            setMasterVolume(value) {
                this.masterVolume = value / 100;
            }
            
            setCymbalBoost(value) {
                this.cymbalBoost = value / 100;
            }
            
            setDrumDuration(value) {
                this.drumDuration = value;
                // é‡æ–°ç”Ÿæˆæ¬¢åº†é”£é¼“éŸ³æ•ˆ
                if (this.buffers.drum) {
                    this.buffers.drum = this.createDrumSound(value);
                }
            }
            
            enableEffects(enabled) {
                this.effectsEnabled = enabled;
                const toggle = document.getElementById('fxToggle');
                const status = document.getElementById('fxStatus');
                
                if (enabled) {
                    toggle.classList.add('on');
                    status.textContent = 'å¼€';
                    status.style.color = '#00ff88';
                } else {
                    toggle.classList.remove('on');
                    status.textContent = 'å…³';
                    status.style.color = '';
                }
            }
            
            updateSystemStatus(message, type = 'loading') {
                const statusEl = document.getElementById('systemStatus');
                const indicator = statusEl.querySelector('.status-indicator');
                
                if (indicator) {
                    indicator.className = 'status-indicator';
                    indicator.classList.add(`status-${type}`);
                }
                
                statusEl.innerHTML = `<span class="status-indicator status-${type}"></span> ${message}`;
            }
            
            updateFileStatus(file, status) {
                // è¿™é‡Œå¯ä»¥æ·»åŠ æ–‡ä»¶çŠ¶æ€æ˜¾ç¤ºé€»è¾‘
            }
            
            enableAllButtons() {
                const buttons = ['gongBtn', 'drumBtn', 'cymbalBtn', 'woodblockBtn', 'clapperBtn', 'bellBtn'];
                buttons.forEach(id => {
                    const btn = document.getElementById(id);
                    if (btn) btn.disabled = false;
                });
            }
        }
        
        // åˆå§‹åŒ–ç³»ç»Ÿ
        const performanceSystem = new UltimatePerformanceSystem();
        
        // DOMåŠ è½½å®Œæˆåç»‘å®šäº‹ä»¶
        document.addEventListener('DOMContentLoaded', () => {
            // éŸ³é‡æ§åˆ¶
            const masterVolume = document.getElementById('masterVolume');
            const volumeValue = document.getElementById('volumeValue');
            
            masterVolume.addEventListener('input', function() {
                const value = this.value;
                volumeValue.textContent = value + '%';
                performanceSystem.setMasterVolume(parseInt(value));
            });
            
            // é•²å£°åŠ å¼ºæ§åˆ¶
            const cymbalBoost = document.getElementById('cymbalBoost');
            const cymbalValue = document.getElementById('cymbalValue');
            
            cymbalBoost.addEventListener('input', function() {
                const value = this.value;
                cymbalValue.textContent = value + '%';
                performanceSystem.setCymbalBoost(parseInt(value));
            });
            
            // æ¬¢åº†é”£é¼“æ—¶é•¿æ§åˆ¶
            const drumDuration = document.getElementById('drumDuration');
            const durationValue = document.getElementById('durationValue');
            
            drumDuration.addEventListener('input', function() {
                const value = parseFloat(this.value);
                durationValue.textContent = value + 'ç§’';
                performanceSystem.setDrumDuration(value);
            });
            
            // ç‰¹æ•ˆå¼€å…³
            const fxToggle = document.getElementById('fxToggle');
            fxToggle.addEventListener('click', function() {
                const currentlyEnabled = performanceSystem.effectsEnabled;
                performanceSystem.enableEffects(!currentlyEnabled);
            });
            
            // æ‰“å‡»ä¹æŒ‰é’®
            document.getElementById('gongBtn').addEventListener('click', () => {
                performanceSystem.toggleInstrument('gong');
            });
            
            document.getElementById('drumBtn').addEventListener('click', () => {
                performanceSystem.toggleInstrument('drum');
            });
            
            document.getElementById('cymbalBtn').addEventListener('click', () => {
                performanceSystem.toggleInstrument('cymbal');
            });
            
            document.getElementById('woodblockBtn').addEventListener('click', () => {
                performanceSystem.toggleInstrument('woodblock');
            });
            
            document.getElementById('clapperBtn').addEventListener('click', () => {
                performanceSystem.toggleInstrument('clapper');
            });
            
            document.getElementById('bellBtn').addEventListener('click', () => {
                performanceSystem.toggleInstrument('bell');
            });
            
            // å¨±ä¹æŒ‰é’®
            document.getElementById('funSurprise').addEventListener('click', () => {
                performanceSystem.playFunEffect('surprise');
            });
            
            document.getElementById('funApplause').addEventListener('click', () => {
                performanceSystem.playFunEffect('applause');
            });
            
            document.getElementById('funDrama').addEventListener('click', () => {
                performanceSystem.playFunEffect('drama');
            });
            
            document.getElementById('funFail').addEventListener('click', () => {
                performanceSystem.playFunEffect('fail');
            });
            
            document.getElementById('funVictory').addEventListener('click', () => {
                performanceSystem.playFunEffect('victory');
            });
            
            document.getElementById('funRandom').addEventListener('click', () => {
                const funTypes = ['surprise', 'applause', 'drama', 'fail', 'victory'];
                const randomType = funTypes[Math.floor(Math.random() * funTypes.length)];
                performanceSystem.playFunEffect(randomType);
            });
            
            // åŒå‡»åœæ­¢æ‰€æœ‰
            let lastTap = 0;
            document.addEventListener('touchstart', function(e) {
                const now = Date.now();
                if (now - lastTap < 300) {
                    performanceSystem.stopAll();
                    e.preventDefault();
                }
                lastTap = now;
                
                // è§£é”éŸ³é¢‘
                if (performanceSystem.audioContext && 
                    performanceSystem.audioContext.state === 'suspended') {
                    performanceSystem.audioContext.resume();
                }
            });
            
            // æ·»åŠ CSSåŠ¨ç”»
            const style = document.createElement('style');
            style.textContent = `
                @keyframes flashEffect {
                    0% { opacity: 0; transform: scale(0.5); }
                    50% { opacity: 0.7; transform: scale(1); }
                    100% { opacity: 0; transform: scale(1.2); }
                }
                
                @keyframes experimentFlash {
                    0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
                    50% { transform: translate(-50%, -50%) scale(1.5); opacity: 0.8; }
                    100% { transform: translate(-50%, -50%) scale(2); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        });
        
        // é˜²æ­¢å±å¹•ä¼‘çœ 
        if ('wakeLock' in navigator) {
            navigator.wakeLock.request('screen').catch(() => {});
        }
    </script>
</body>
</html>
